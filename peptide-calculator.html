<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ü–µ–ø—Ç–∏–¥–æ–≤ | Nefarma</title>

  <meta name="description" content="–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–Ω–ª–∞–π–Ω-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–∑–∏—Ä–æ–≤–æ–∫ –ø–µ–ø—Ç–∏–¥–æ–≤ —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏, –∏—Å—Ç–æ—Ä–∏–µ–π, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —à–ø–∞—Ä–≥–∞–ª–∫–æ–π –∏ –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π." />
  <meta property="og:title" content="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–µ–ø—Ç–∏–¥–æ–≤ Nefarma" />
  <meta property="og:description" content="–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–π—Ç–µ –¥–æ–∑–∏—Ä–æ–≤–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–µ—Å–µ—Ç—ã, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é. –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∏ –º–æ–±–∏–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/og-card.jpg" />
  <meta property="og:locale" content="ru_RU" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap&subset=cyrillic" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap&subset=cyrillic">
  </noscript>

  <style>
    :root{
      --bg:#0f1012; --surf:#181a1f; --text:#f4f6f8; --muted:#aeb6c2;
      --primary:#00aaff; --primary-2:#0088cc; --warn:#ffc107; --ok:#19c37d; --border:#2a2f36;
      --r:14px; --shadow:0 8px 28px rgba(0,0,0,.25);
      --tap:44px;
    }
    html[data-theme="light"]{
      --bg:#ffffff; --surf:#f6f7f9; --text:#0f1115; --muted:#4b5563; --border:#e5e7eb;
      --shadow:0 10px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; background:var(--bg); color:var(--text); line-height:1.6}

    /* Layout */
    .container{max-width:980px; margin:0 auto; padding: clamp(12px, 4vw, 24px)}
    header{position:sticky; top:0; z-index:40; background:rgba(15,16,18,.75); backdrop-filter:saturate(130%) blur(8px); border-bottom:1px solid var(--border)}
    html[data-theme="light"] header{background:rgba(255,255,255,.85)}
    .hdr{display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; min-height:60px; padding:8px 12px}
    .logo{display:flex; align-items:center; gap:10px; color:inherit; text-decoration:none}
    .logo img{height:32px; width:auto}
    html[data-theme="light"] .logo img {filter: invert(1);}
    .row{display:flex; align-items:center; gap:10px}
    .card{background:var(--surf); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow)}
    .section{padding: clamp(14px, 3.2vw, 22px)}
    h1{margin:8px 0 12px; font-size:clamp(22px, 6vw, 32px)}
    h2{margin:0 0 12px; font-size:clamp(18px, 5vw, 24px)}
    h3{font-size: 1.1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem;}
    .muted{color:var(--muted)}

    /* Calculator Styles */
    .calc-container {display: flex; flex-wrap: wrap; gap: 1.5rem;}
    .calc-column-1 {flex: 1 1 380px;}
    .calc-column-2 {flex: 2 1 500px;}
    .calc-step {margin-bottom: 2rem;}
    .calc_subtitle {font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; display: block;}
    .input-grid {display: flex; flex-wrap: wrap; gap: 8px; align-items: center;}
    .syringe-input {display: none;}
    .syringe-label {display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 10px; border: 2px solid var(--border); border-radius: var(--r); transition: border-color 0.3s, background-color 0.3s;}
    .syringe-label span {font-weight: 600; margin-bottom: 8px;}
    .syringe-label img {max-width: 100%; height: 40px; object-fit: contain;}
    .syringe-input:checked + .syringe-label {border-color: var(--primary); background-color: rgba(0, 170, 255, 0.1);}
    .choice-label {padding: 10px 16px; min-height:var(--tap); border: 1px solid var(--border); background-color: var(--surf); border-radius: 10px; cursor: pointer; font-weight: 600; transition: background-color 0.2s, color 0.2s; text-align: center;}
    html[data-theme="light"] .choice-label:hover {background-color: #e9ecef;}
    html[data-theme="dark"] .choice-label:hover {background-color: #2a2f36;}
    .syringe-input:checked + .choice-label {background: var(--primary); border-color: var(--primary); color: #fff;}
    
    .other-input {width: 100px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-size: 1rem; text-align: center; display: none;}
    .syringe-input.other:checked ~ .other-input {display: inline-block;}
    input[type=number]{appearance:textfield}
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button{appearance:none; margin:0}

    /* Result Block */
    .result_block {margin-top: 2rem;}
    .text_result {font-size: clamp(18px, 4vw, 22px); font-weight: bold; margin-bottom: 1.5rem;}
    #result_scale {padding: 1rem 0;}
    .ruler {display: flex; width: 100%; height: 30px; border-bottom: 2px solid var(--text); position: relative;}
    .ruler .tick {position: absolute; bottom: 0; height: 15px; width: 2px; background-color: var(--text);}
    .ruler .long {height: 25px;}
    .ruler .label {position: absolute; bottom: -25px; transform: translateX(-50%); font-size: 12px; color: var(--muted);}
    .ruler .filled-area {position: absolute; height: 30px; background-color: rgba(255, 165, 0, 0.5); top: 0; left: 0; border-right: 2px solid #FFA500; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);}
    .ruler .error-message {position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--warn); font-weight: bold; text-align: center; background-color: rgba(0,0,0,0.5);}

    /* Stats Display */
    .stats{display:grid; gap:10px; margin-top:1.5rem}
    @media (min-width:680px){.stats{grid-template-columns:repeat(2,1fr)}}
    .stat{border:1px dashed var(--border); border-radius:12px; background:var(--bg); padding:12px; position:relative}
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:clamp(20px, 5vw, 26px); font-weight:700}
    .stat .u{font-size:14px; color:var(--muted); font-weight:600; margin-left:6px}
    .pulse{animation:pulse .9s ease}
    @keyframes pulse{from{box-shadow:0 0 0 0 rgba(0,170,255,.35)} to{box-shadow:0 0 0 10px rgba(0,170,255,0)}}

    /* Buttons */
    .btn{min-height:var(--tap); padding:0 14px; border-radius:12px; border:1px solid var(--border); background:var(--bg); color:var(--text); font-weight:700; cursor:pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center;}
    html[data-theme="light"] .btn{background:var(--surf); color: var(--text);}
    .btn.primary{background:var(--primary); border-color:var(--primary); color:#fff}
    .btn.subtle{background:transparent;}

    /* Interactive Cheat Sheet */
    .interactive-example {
        color: var(--primary);
        cursor: pointer;
        border-bottom: 1px dashed var(--primary);
        font-weight: 500;
    }

    /* History List */
    #history-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 200px;
        overflow-y: auto;
    }
    #history-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 4px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
    }
    #history-list li:last-child { border-bottom: none; }
    .history-item-result { font-weight: bold; }
    .history-item-details { color: var(--muted); }
    
    /* Mobile Dock */
    .dock {
        display: none; /* Hidden on desktop */
        position: sticky;
        bottom: 0;
        z-index: 50;
        padding: 8px;
        margin-top: 12px;
        background: linear-gradient(to top, var(--bg) 50%, transparent);
    }
    .dock .bar {
        display: flex;
        gap: 8px;
        background: var(--surf);
        border: 1px solid var(--border);
        border-radius: var(--r);
        padding: 8px;
        box-shadow: var(--shadow);
    }
    .dock .bar .btn { flex: 1; }
    @media (max-width: 768px) {
        .dock { display: block; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container hdr">
      <a class="logo" href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é Nefarma">
        <img src="logo.webp" alt="Nefarma" width="128" height="32" />
      </a>
      <div class="row">
        <button id="theme" class="btn" aria-pressed="true" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <section class="card section" style="margin-bottom:10px">
      <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ü–µ–ø—Ç–∏–¥–æ–≤</h1>
      <p class="muted">–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–∑–∏—Ä–æ–≤–æ–∫ —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏, –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏.</p>
    </section>

    <section class="card section">
      <h2>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h2>
      <div class="calc-container">
        <div class="calc-column-1">
          <div class="calc-step">
            <label class="calc_subtitle">1. –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–º —à–ø—Ä–∏—Ü–∞:</label>
            <div class="input-grid">
                <input type="radio" name="syringe_volume" id="syringe_0.3" class="syringe-input" value="0.3"><label for="syringe_0.3" class="syringe-label"><span>0.3 –º–ª</span><img src="https://static.tildacdn.pro/tild3538-3732-4239-a661-613236356134/30_.svg" alt="0.3 –º–ª"></label>
                <input type="radio" name="syringe_volume" id="syringe_0.5" class="syringe-input" value="0.5"><label for="syringe_0.5" class="syringe-label"><span>0.5 –º–ª</span><img src="https://static.tildacdn.pro/tild3031-6433-4935-b835-353735353230/_50.svg" alt="0.5 –º–ª"></label>
                <input type="radio" name="syringe_volume" id="syringe_1" class="syringe-input" value="1" checked><label for="syringe_1" class="syringe-label"><span>1 –º–ª</span><img src="https://static.tildacdn.pro/tild3565-3836-4366-b766-383037636432/100_.png" alt="1 –º–ª"></label>
            </div>
          </div>
          <div class="calc-step">
            <label class="calc_subtitle">–ü—Ä–µ—Å–µ—Ç—ã (–∑–∞–≥–æ—Ç–æ–≤–∫–∏)</label>
            <div id="presets-container" class="input-grid">
                </div>
            <button id="save_preset" class="btn primary" style="margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–∞–∫ –ø—Ä–µ—Å–µ—Ç</button>
          </div>
        </div>

        <div class="calc-column-2">
            <div class="calc-step">
              <label class="calc_subtitle">2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ–ø—Ç–∏–¥–∞ (–º–≥)</label>
              <div class="input-grid">
                  <input type="radio" name="peptide_volume" id="peptide_2" class="syringe-input" value="2"><label for="peptide_2" class="choice-label">2 –º–≥</label>
                  <input type="radio" name="peptide_volume" id="peptide_5" class="syringe-input" value="5"><label for="peptide_5" class="choice-label">5 –º–≥</label>
                  <input type="radio" name="peptide_volume" id="peptide_10" class="syringe-input" value="10" checked><label for="peptide_10" class="choice-label">10 –º–≥</label>
                  <input type="radio" name="peptide_volume" id="peptide_other" class="syringe-input other" value="other"><label for="peptide_other" class="choice-label">–î—Ä—É–≥–æ–µ</label>
                  <input type="number" id="peptide_other_input" class="other-input" placeholder="–º–≥">
              </div>
            </div>

            <div class="calc-step">
              <label class="calc_subtitle">3. –û–±—ä—ë–º —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª—è (–º–ª)</label>
              <div class="input-grid">
                  <input type="radio" name="water_volume" id="water_1" class="syringe-input" value="1"><label for="water_1" class="choice-label">1 –º–ª</label>
                  <input type="radio" name="water_volume" id="water_2" class="syringe-input" value="2" checked><label for="water_2" class="choice-label">2 –º–ª</label>
                  <input type="radio" name="water_volume" id="water_3" class="syringe-input" value="3"><label for="water_3" class="choice-label">3 –º–ª</label>
                  <input type="radio" name="water_volume" id="water_other" class="syringe-input other" value="other"><label for="water_other" class="choice-label">–î—Ä—É–≥–æ–µ</label>
                  <input type="number" id="water_other_input" class="other-input" placeholder="–º–ª">
              </div>
            </div>
            
            <div class="calc-step">
              <label class="calc_subtitle">4. –ù—É–∂–Ω–∞—è –¥–æ–∑–∏—Ä–æ–≤–∫–∞ (–º–≥)</label>
              <div class="input-grid">
                  <input type="radio" name="dose_volume" id="dose_0.25" class="syringe-input" value="0.25"><label for="dose_0.25" class="choice-label">0.25 –º–≥</label>
                  <input type="radio" name="dose_volume" id="dose_0.5" class="syringe-input" value="0.5"><label for="dose_0.5" class="choice-label">0.5 –º–≥</label>
                  <input type="radio" name="dose_volume" id="dose_1" class="syringe-input" value="1"><label for="dose_1" class="choice-label">1 –º–≥</label>
                  <input type="radio" name="dose_volume" id="dose_2.5" class="syringe-input" value="2.5" checked><label for="dose_2.5" class="choice-label">2.5 –º–≥</label>
                  <input type="radio" name="dose_volume" id="dose_5" class="syringe-input" value="5"><label for="dose_5" class="choice-label">5 –º–≥</label>
                  <input type="radio" name="dose_volume" id="dose_other" class="syringe-input other" value="other"><label for="dose_other" class="choice-label">–î—Ä—É–≥–æ–µ</label>
                  <input type="number" id="dose_other_input" class="other-input" placeholder="–º–≥">
              </div>
            </div>
        </div>
      </div>
      
      <div class="result_block">
        <div class="text_result">
          –†–µ–∑—É–ª—å—Ç–∞—Ç: –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ–∑—É <span id="dose_volume_text">2.5 –º–≥</span>, –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ —à–ø—Ä–∏—Ü –¥–æ –æ—Ç–º–µ—Ç–∫–∏ <span id="result_mark">50.0</span>
        </div>
        <div id="result_scale"></div>
        <div class="stats">
            <div class="stat" id="stat_conc">
                <div class="k">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å—Ç–≤–æ—Ä–∞</div>
                <div class="v"><span id="out_conc">5.000</span><span class="u">–º–≥/–º–ª</span></div>
            </div>
            <div class="stat" id="stat_doses">
                <div class="k">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∑ –∏–∑ —Ñ–ª–∞–∫–æ–Ω–∞</div>
                <div class="v"><span id="out_doses">4</span><span class="u">–¥–æ–∑(—ã)</span></div>
            </div>
        </div>
        <div style="margin-top: 1.5rem; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="share_result" class="btn primary">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</button>
            <button id="clear_form" class="btn">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
      </div>
    </section>
    
    <div class="grid grid-2" style="gap: 10px; margin-top: 10px;">
        <section class="card section">
            <h2>–®–ø–∞—Ä–≥–∞–ª–∫–∞</h2>
            <p class="muted">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.</p>
            <h3>–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–æ —à–ø—Ä–∏—Ü U-100</h3>
            <p class="muted">–ò–Ω—Å—É–ª–∏–Ω–æ–≤—ã–π —à–ø—Ä–∏—Ü U-100 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ–≥–æ –æ–±—ä–µ–º –≤ 1 –º–ª —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ 100 –¥–µ–ª–µ–Ω–∏–π (IU).</p>
            <ul style="list-style-type: none; padding-left: 0; color: var(--muted);">
                <li>100 IU = 1 –º–ª</li>
                <li>10 IU = 0.1 –º–ª</li>
                <li>1 IU = 0.01 –º–ª</li>
            </ul>
            
            <h3>–ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
            <p class="muted">1. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è: <span class="interactive-example" data-peptide="10" data-water="2">10 –º–≥ –ø–µ–ø—Ç–∏–¥–∞ –≤ 2 –º–ª –≤–æ–¥—ã</span> = 5 –º–≥/–º–ª.</p>
            <p class="muted">2. –î–æ–∑–∏—Ä–æ–≤–∫–∞: –ù—É–∂–Ω–∞ –¥–æ–∑–∞ <span class="interactive-example" data-peptide="10" data-water="2" data-dose="2.5">2.5 –º–≥</span> –ø—Ä–∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ 5 –º–≥/–º–ª. –†–∞—Å—á–µ—Ç: 2.5 –º–≥ √∑ 5 –º–≥/–º–ª = 0.5 –º–ª.</p>
            <p class="muted">3. –î–µ–ª–µ–Ω–∏—è: 0.5 –º–ª √ó 100 = 50 –¥–µ–ª–µ–Ω–∏–π (IU).</p>
        </section>

        <section class="card section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
                <button id="clear_history" class="btn subtle">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <ul id="history-list">
                </ul>
        </section>
    </div>

    <div class="dock">
        <div class="bar">
            <button id="dock_share" class="btn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button id="dock_clear" class="btn primary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

  </main>

  <script>
    (function(){
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => r.querySelectorAll(s);

      // --- Theme ---
      const themeBtn = $('#theme');
      const loadTheme = () => {
          const theme = localStorage.getItem('nefarma_theme') || 'dark';
          document.documentElement.dataset.theme = theme;
          themeBtn.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
      };
      themeBtn.addEventListener('click', () => {
        const nextTheme = document.documentElement.dataset.theme === 'light' ? 'dark' : 'light';
        document.documentElement.dataset.theme = nextTheme;
        themeBtn.textContent = nextTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('nefarma_theme', nextTheme);
      });

      // --- UI Elements ---
      const allInputs = $$('.syringe-input, .other-input');
      const doseVolumeSpan = $('#dose_volume_text');
      const resultMarkSpan = $('#result_mark');
      const resultScaleDiv = $('#result_scale');
      const out_conc = $('#out_conc');
      const out_doses = $('#out_doses');
      const shareBtn = $('#share_result');
      const clearBtn = $('#clear_form');
      const dockShareBtn = $('#dock_share');
      const dockClearBtn = $('#dock_clear');
      
      // --- Helper Functions ---
      const notify = (msg='–ì–æ—Ç–æ–≤–æ') => { /* Visual feedback for actions */ }; // Simplified for brevity
      const getCheckedValue = (name) => {
          const otherRadio = $(`input[name="${name}"].other`);
          if (otherRadio?.checked) {
              const otherInput = $(`#${name.replace('_volume', '')}_other_input`);
              return otherInput.value;
          }
          return $(`input[name="${name}"]:checked`)?.value || 0;
      };
      const setCheckedValue = (name, value) => {
          const specificRadio = $(`input[name="${name}"][value="${value}"]`);
          if (specificRadio) {
              specificRadio.checked = true;
          } else {
              const otherRadio = $(`input[name="${name}"].other`);
              const otherInput = $(`#${name.replace('_volume', '')}_other_input`);
              if (otherRadio && otherInput) {
                  otherRadio.checked = true;
                  otherInput.value = value;
              }
          }
      };
      
      // --- Main Calculation Logic ---
      function calculateAndDisplayResult(saveToHistory = true) {
          const syringeValue = parseFloat(getCheckedValue('syringe_volume'));
          const peptideValue = parseFloat(getCheckedValue('peptide_volume'));
          const waterValue = parseFloat(getCheckedValue('water_volume'));
          const doseValue = parseFloat(getCheckedValue('dose_volume'));

          if (![syringeValue, peptideValue, waterValue, doseValue].every(v => v > 0)) {
              resultMarkSpan.textContent = "0.0";
              out_conc.textContent = "0.000";
              out_doses.textContent = "0";
              drawSyringeScale(syringeValue, 0);
              return;
          }

          doseVolumeSpan.textContent = `${doseValue} –º–≥`;
          const concentration = peptideValue / waterValue;
          const totalDoses = Math.floor(peptideValue / doseValue);
          const resultInUnits = (doseValue / concentration) * 100;

          resultMarkSpan.textContent = resultInUnits.toFixed(1);
          out_conc.textContent = concentration.toFixed(3);
          out_doses.textContent = totalDoses;
          
          $$('.stat, .text_result').forEach(el => {
              el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
          });

          drawSyringeScale(syringeValue, resultInUnits);
          
          if (saveToHistory) {
              History.add({ syringeValue, peptideValue, waterValue, doseValue, resultInUnits });
          }
      }

      function drawSyringeScale(syringeVolume, result) {
          resultScaleDiv.innerHTML = '';
          let maxUnits;
          if (syringeVolume === 0.3) maxUnits = 30;
          else if (syringeVolume === 0.5) maxUnits = 50;
          else if (syringeVolume === 1) maxUnits = 100;
          else return;

          const rulerDiv = document.createElement('div');
          rulerDiv.className = 'ruler';

          for (let i = 0; i <= maxUnits; i += 5) {
              const tickDiv = document.createElement('div');
              tickDiv.style.left = (i / maxUnits * 100) + '%';
              tickDiv.className = 'tick long';
              const labelSpan = document.createElement('span');
              labelSpan.className = 'label';
              labelSpan.textContent = i;
              tickDiv.appendChild(labelSpan);
              rulerDiv.appendChild(tickDiv);
          }
          
          const filledDiv = document.createElement('div');
          filledDiv.className = 'filled-area';
          rulerDiv.appendChild(filledDiv);
          // Animate the width after appending
          setTimeout(() => {
              let fillPercentage = (result / maxUnits * 100);
              filledDiv.style.width = (fillPercentage > 100 ? 100 : fillPercentage) + '%';
          }, 10);
          
          if (result > maxUnits) {
              const errorDiv = document.createElement('div');
              errorDiv.className = 'error-message';
              errorDiv.textContent = '–î–æ–∑–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ–±—ä–µ–º —à–ø—Ä–∏—Ü–∞!';
              rulerDiv.appendChild(errorDiv);
          }
          resultScaleDiv.appendChild(rulerDiv);
      }

      // --- Presets ---
      const Presets = {
          key: 'nefarma_presets',
          getAll: () => JSON.parse(localStorage.getItem(Presets.key) || '[]'),
          saveAll: (presets) => localStorage.setItem(Presets.key, JSON.stringify(presets)),
          add: (preset) => {
              let presets = Presets.getAll();
              presets.push(preset);
              Presets.saveAll(presets);
              Presets.render();
          },
          load: (preset) => {
              setCheckedValue('peptide_volume', preset.peptide);
              setCheckedValue('water_volume', preset.water);
              calculateAndDisplayResult();
          },
          render: () => {
              const container = $('#presets-container');
              container.innerHTML = '';
              Presets.getAll().forEach(p => {
                  const btn = document.createElement('button');
                  btn.className = 'btn subtle';
                  btn.textContent = `${p.peptide} –º–≥ / ${p.water} –º–ª`;
                  btn.onclick = () => Presets.load(p);
                  container.appendChild(btn);
              });
          }
      };
      $('#save_preset').addEventListener('click', () => {
          const peptide = getCheckedValue('peptide_volume');
          const water = getCheckedValue('water_volume');
          if (peptide > 0 && water > 0) {
              Presets.add({ peptide, water });
          }
      });
      
      // --- History ---
      const History = {
          key: 'nefarma_history',
          getAll: () => JSON.parse(localStorage.getItem(History.key) || '[]'),
          saveAll: (history) => localStorage.setItem(History.key, JSON.stringify(history.slice(-5))),
          add: (item) => {
              let history = History.getAll();
              history.push({ ...item, ts: new Date().toISOString() });
              History.saveAll(history);
              History.render();
          },
          clear: () => {
              History.saveAll([]);
              History.render();
          },
          render: () => {
              const list = $('#history-list');
              list.innerHTML = '';
              History.getAll().reverse().forEach(h => {
                  const li = document.createElement('li');
                  li.innerHTML = `
                      <span class="history-item-details">${h.peptideValue}–º–≥/${h.waterValue}–º–ª ‚Üí ${h.doseValue}–º–≥</span>
                      <span class="history-item-result">${h.resultInUnits.toFixed(1)} IU</span>
                  `;
                  list.appendChild(li);
              });
          }
      };
      $('#clear_history').addEventListener('click', History.clear);

      // --- Sharing ---
      const shareAction = async () => {
          const textToShare = `üß™ –†–∞—Å—á—ë—Ç –¥–æ–∑–∏—Ä–æ–≤–∫–∏:\n- –§–ª–∞–∫–æ–Ω: ${getCheckedValue('peptide_volume')} –º–≥\n- –†–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª—å: ${getCheckedValue('water_volume')} –º–ª\n- –ñ–µ–ª–∞–µ–º–∞—è –¥–æ–∑–∞: ${getCheckedValue('dose_volume')} –º–≥\n\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:\n- –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è: ${out_conc.textContent} –º–≥/–º–ª\n- –ù–∞–±—Ä–∞—Ç—å –≤ —à–ø—Ä–∏—Ü: ${resultMarkSpan.textContent} –µ–¥–∏–Ω–∏—Ü (U-100)`;
          if (navigator.share) {
              await navigator.share({ title: '–†–∞—Å—á—ë—Ç –¥–æ–∑–∏—Ä–æ–≤–∫–∏ –ø–µ–ø—Ç–∏–¥–∞', text: textToShare });
          } else {
              await navigator.clipboard.writeText(textToShare);
              alert('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
          }
      };
      shareBtn.addEventListener('click', shareAction);
      dockShareBtn.addEventListener('click', shareAction);
      
      // --- Clear Form ---
      const clearAction = () => {
          $$('input[type="number"]').forEach(i => i.value = '');
          // Reset to default radios
          $('#syringe_1').checked = true;
          $('#peptide_10').checked = true;
          $('#water_2').checked = true;
          $('#dose_2.5').checked = true;
          calculateAndDisplayResult();
      };
      clearBtn.addEventListener('click', clearAction);
      dockClearBtn.addEventListener('click', clearAction);
      
      // --- Interactive Cheat Sheet ---
      $$('.interactive-example').forEach(el => {
          el.addEventListener('click', () => {
              const { peptide, water, dose } = el.dataset;
              if (peptide) setCheckedValue('peptide_volume', peptide);
              if (water) setCheckedValue('water_volume', water);
              if (dose) setCheckedValue('dose_volume', dose);
              calculateAndDisplayResult();
              // Scroll to calculator on mobile
              if (window.innerWidth < 768) {
                  $('.calc-container').scrollIntoView({ behavior: 'smooth' });
              }
          });
      });

      // --- Initial Load ---
      allInputs.forEach(input => input.addEventListener('change', () => calculateAndDisplayResult()));
      loadTheme();
      Presets.render();
      History.render();
      calculateAndDisplayResult(false); // Initial calculation without saving to history
    })();
  </script>
</body>
</html>