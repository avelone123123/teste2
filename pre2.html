<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>СПОРТИВНАЯ FARMA ПО ВСЕМУ КАЗАХСТАНУ</title>
  <meta name="description" content="Лучшие препараты от Фармаком по предзаказу. Низкие цены, гарантия качества, доставка по Казахстану.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    :root {
      --bg-color: #0f1115;
      --surface-color: #1a1f29;
      --primary-color: #00aaff;
      --primary-hover-color: #0088cc;
      --text-color: #f0f3f7;
      --text-muted-color: #9aa8b4;
      --border-color: #2b3442;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --highlight-bg: rgba(0, 170, 255, 0.08);
      --font-main: 'Inter', system-ui, -apple-system, sans-serif;
      --border-radius: 14px;
      --shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
      --tag-bestseller-bg: #ef4444;
      --tag-new-bg: #2563eb;
      --tag-low-stock-bg: #a16207;
      --tag-text-color: #ffffff;
      --accent-1: #0ea5e9;
      --accent-2: #22c55e;
      --accent-3: #a855f7;
      --kaspi-color: #f14635;
    }
    .icon { width: 1em; height: 1em; margin-right: 8px; vertical-align: middle; }
    body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; font-size: 16px; }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

    .header { background: linear-gradient(to right, rgba(14,165,233,0.15), rgba(168,85,247,0.15)); padding: 15px 0; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; }
    .header .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 15px; }
    .logo img { height: 40px; width: auto; display: block; }

    #countdown-container {
      background: linear-gradient(#141925, #141925) padding-box, linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3)) border-box;
      border: 1px solid transparent; border-radius: var(--border-radius); padding: 8px 15px; text-align: center; margin: 10px auto 0; width: fit-content; box-shadow: var(--shadow);
    }
    #countdown-container .title { font-size: 12px; text-transform: uppercase; color: var(--text-muted-color); letter-spacing: 0.5px; }
    #countdown-timer { font-size: 22px; font-weight: 700; color: var(--primary-color); letter-spacing: 1px; }
    #countdown-container.expired #countdown-timer { color: var(--tag-bestseller-bg); font-size: 16px; }

    .calculator-container { max-width: 1200px; margin: auto; }
    .filter-wrapper { margin: 15px 0; max-width: 100%; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .filter-input { flex-grow: 1; padding: 12px 15px; background: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 16px; box-sizing: border-box; min-width: 200px; max-width: 520px; }
    .filter-input::placeholder { color: var(--text-muted-color); }

    .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 320px)); gap: 20px; justify-content: center; align-content: start; margin-top: 20px; }

    .product-card {
      background: linear-gradient(#151a24, #151a24) padding-box, linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3)) border-box;
      border: 1px solid transparent; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.35);
      overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease; max-width: 360px;
    }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,0.45); filter: saturate(1.05); }
    .product-card-image-wrapper { position: relative; background: radial-gradient(1200px 300px at 10% 0%, rgba(14,165,233,0.18), transparent 40%), radial-gradient(1200px 300px at 90% 0%, rgba(168,85,247,0.15), transparent 40%), #0f1115; }
    .product-card-image { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; display: block; }
    .tags-container { position: absolute; top: 12px; left: 12px; display: flex; flex-direction: column; gap: 6px; }
    .tag { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 999px; color: var(--tag-text-color); text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    .tag-bestseller { background-color: var(--tag-bestseller-bg); }
    .tag-new { background-color: var(--tag-new-bg); }
    .tag-low-stock { background-color: var(--tag-low-stock-bg); }

    .product-card-content { padding: 16px; display: flex; flex-direction: column; flex-grow: 1; }
    .product-card-name { font-size: 18px; font-weight: 600; margin: 0 0 12px 0; flex-grow: 1; line-height: 1.4; }
    .product-card-prices { display: grid; gap: 8px; margin-bottom: 16px; font-size: 13px; }
    .price-tier { display: flex; justify-content: space-between; padding: 8px 10px; border-radius: 10px; background-color: rgba(255,255,255,0.03); transition: background-color 0.3s ease, border 0.3s ease; border: 1px solid #1f2633; }
    .price-tier.active { background-color: var(--highlight-bg); border-color: var(--primary-color); }
    .price-tier-label { color: var(--text-muted-color); }
    .price-tier-value { font-weight: 700; color: var(--text-color); }
    .price-tier.active .price-tier-value { color: var(--primary-color); }

    .product-card-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color); }
    .quantity-control { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .quantity-btn { background: #223044; color: var(--text-color); border: none; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; transition: transform 0.15s ease, background-color 0.2s; }
    .quantity-btn:hover { background: #274059; transform: translateY(-1px); }

    .quantity-input { width: 100%; height: 44px; text-align: center; background: #0f141d; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 10px; font-size: 16px; font-weight: 600;
      -moz-appearance: textfield; appearance: textfield; -webkit-appearance: none; }
    .quantity-input::-webkit-outer-spin-button, .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .subtotal { margin-top: 12px; text-align: right; font-size: 16px; font-weight: 700; }
    .subtotal-label { font-weight: 500; color: var(--text-muted-color); }

    .summary-panel {
      background: linear-gradient(#151a24, #151a24) padding-box, linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3)) border-box;
      border: 1px solid transparent; border-radius: var(--border-radius); padding: 20px; margin-top: 20px; box-shadow: var(--shadow);
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    }
    .totals { font-size: 14px; line-height: 1.6; flex-grow: 1; width: 100%; }
    .totals #tier { font-weight: 600; color: var(--primary-color); }
    .final-total { font-size: 24px; font-weight: 800; }
    .savings { color: var(--success-color); font-weight: 600; }
    .actions { width: 100%; display: flex; gap: 15px; flex-wrap: wrap; }
    .action-button { padding: 12px 18px; font-size: 16px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; text-align: center; flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 8px; line-height: 1.2; transition: transform 0.15s ease, opacity 0.2s, box-shadow 0.2s; }
    .action-button:disabled { background-color: #3b4658 !important; background-image: none !important; cursor: not-allowed; opacity: 0.6; }
    .whatsapp-btn { background: linear-gradient(90deg, var(--success-color), #2dd4bf); color: #062112; box-shadow: 0 6px 20px rgba(34,197,94,0.25); }
    .whatsapp-btn:hover:not(:disabled) { transform: translateY(-2px); }
    .kaspi-btn { background-color: var(--kaspi-color); color: white; box-shadow: 0 6px 20px rgba(241, 70, 53, 0.25); }
    .kaspi-btn:hover:not(:disabled) { transform: translateY(-2px); background-color: #d43c2b; }
    .clear-btn { background: linear-gradient(90deg, #ef4444, #f97316); color: white; box-shadow: 0 6px 20px rgba(239,68,68,0.25); }
    .clear-btn:hover:not(:disabled) { transform: translateY(-2px); }
    #copyOrderBtn { background: linear-gradient(90deg, #3b82f6, #8b5cf6); color: white; box-shadow: 0 6px 20px rgba(59,130,246,0.25); }
    #copyOrderBtn:hover:not(:disabled) { transform: translateY(-2px); }

    #loader { text-align: center; padding: 40px; font-size: 16px; color: var(--text-muted-color); display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 12px 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease; transform: translateX(-50%) translateY(20px); display: flex; align-items: center; gap: 10px; }
    .toast-notification.warning { background-color: var(--tag-low-stock-bg); }
    .toast-notification.success { background-color: var(--success-color); }
    .toast-notification.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .scroll-top-btn { display: none; position: fixed; bottom: 70px; right: 15px; background: var(--primary-color); color: white; width: 44px; height: 44px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; z-index: 1000; opacity: 0.85; box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
    .scroll-top-btn:hover { opacity: 1; }
    .scroll-top-btn.visible { display: block; }

    @media (max-width: 768px) {
      body { padding: 10px; font-size: 14px; }
      .product-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
      .summary-panel { flex-direction: column; align-items: stretch; text-align: center; gap: 15px; }
      .actions { width: 100%; flex-direction: column; gap: 10px; }
      .action-button { width: 100%; padding: 14px 18px; font-size: 16px; }
      .filter-wrapper { flex-direction: column; }
      .header .container { justify-content: center; text-align: center; }
    }
    @media (max-width: 480px) {
      .product-grid { grid-template-columns: 1fr; }
      .product-card-name { font-size: 17px; }
      #countdown-timer { font-size: 18px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <a href="index.html" class="logo" aria-label="На главную">
        <img src="logo.webp" alt="Логотип" width="286" height="40" loading="eager">
      </a>
      <div id="countdown-container" style="display: none;">
        <div class="title">До конца предзаказа</div>
        <div id="countdown-timer">00:00:00:00</div>
      </div>
    </div>
  </header>

  <div class="calculator-container" id="app" style="display: none;">
    <h1 style="text-align:center;">Предзаказ фармы в Казахстане</h1>
    <div class="filter-wrapper">
      <label for="filterInput" class="visually-hidden">Поиск по прайс-листу</label>
      <input type="text" class="filter-input" id="filterInput" placeholder="🔍 Поиск по названию...">
    </div>
    <div id="product-grid" class="product-grid"></div>

    <div class="preorder-conditions" style="margin-top: 20px; padding: 20px; background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow);">
      <h2 style="text-align:center; margin-top:0; font-size: 18px; color: var(--text-color);">Условия предзаказа</h2>
      <ul style="padding-left: 20px; margin-bottom: 0; line-height: 1.7; list-style-type: '✔ '; font-size: 14px; color: var(--text-muted-color);">
        <li style="padding-left: 10px; margin-bottom: 12px; color: var(--warning-color);"><strong style="color: var(--text-color);">Срок ожидания:</strong> Пожалуйста, обратите внимание, что срок ожидания заказа с момента оплаты составляет <strong style="color: #f59e0b;">3-4 недели</strong>.</li>
        <li style="padding-left: 10px; margin-bottom: 12px;"><strong style="color: var(--text-color);">Условия оплаты:</strong> Для подтверждения предзаказа требуется 100% предоплата.</li>
        <li style="padding-left: 10px; margin-bottom: 12px;"><strong style="color: var(--text-color);">Если товара не будет в наличии:</strong> В редких случаях поставка может быть отменена. Мы немедленно сообщим вам об этом и вернем полную сумму предоплаты либо предложим альтернативу.</li>
        <li style="padding-left: 10px; margin-bottom: 12px;"><strong style="color: var(--text-color);">Отмена и возврат:</strong> Возврат денег и отмена предзаказа возможны в любое время. Возврат денежных средств будет осуществлен в течение 48 часов.</li>
      </ul>
    </div>

    <div class="summary-panel">
      <div class="totals">
        <div style="display:none;">Применяется ценовой уровень: <span id="tier"></span></div>
        <div style="display:none;"><span class="savings" id="savings">Экономия: 0 ₸</span></div>
        <div>Итоговая сумма: <span class="final-total" id="total">0 ₸</span></div>
        <div id="minOrderMessage" style="color: var(--warning-color); font-weight: 700; margin-top: 10px; display: none;"></div>
      </div>
      <div class="order-instructions" style="text-align: center; margin: 15px 0 5px 0; width: 100%;">
        <p style="margin: 0; color: var(--text-color); font-size: 15px; font-weight: 600;">Выберите способ оформления заказа:</p>
        <p style="margin: 5px 0 0 0; color: var(--text-muted-color); font-size: 13px;">Нажмите на одну из кнопок, чтобы отправить заказ нам в WhatsApp.</p>
      </div>
      <div class="actions" style="grid-template-columns: 1fr 1fr; display: grid;">
        <button class="action-button whatsapp-btn" id="buyDirectBtn" onclick="app.sendOrder()">
          <svg class="icon" viewBox="0 0 448 512" width="20" height="20"><path fill="currentColor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.8 0-65.7-8.9-94-25.4l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"></path></svg>
          Оформить в WhatsApp
        </button>
        <button class="action-button kaspi-btn" id="kaspiBtn" onclick="app.sendKaspiOrder()">
          <svg class="icon" viewBox="0 0 448 512" width="20" height="20"><path fill="currentColor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.8 0-65.7-8.9-94-25.4l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"></path></svg>
          Kaspi 0-0-12
        </button>
      </div>
      <div class="actions" style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <button class="action-button" id="copyOrderBtn" onclick="app.copyOrderForChat()">
          <svg class="icon" viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
          Копировать
        </button>
        <button class="action-button clear-btn" onclick="app.clearOrder()">
          <svg class="icon" viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
          Очистить
        </button>
      </div>
    </div>
  </div>

  <div id="loader">
    <div class="loader-spinner"></div>
    <div>Загрузка прайс-листа...</div>
  </div>
  <div id="toast" class="toast-notification"></div>
  <button class="scroll-top-btn" id="scrollTopBtn" title="Наверх">
    <svg class="icon" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M13 19V7.83l4.59 4.59L19 11l-7-7-7 7 1.41 1.41L11 7.83V19h2z"></path></svg>
  </button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const app = {
      config: {
        csvPath: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbJ43MOGmEjMaB6PV8j3tr63nnErTHxCH431JvdqWZCvtQYXWhzGl_RS05qLBC81QT60aIBsmfVX2c/pub?output=csv",
        timerCsvPath: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSdZbVTUwj1zR_y-FcneMiKDd20ezwM3XaGM8hRY7ja4IzRieyonxS0OYQHa3tTadeCTmMLvLvhQqaQ/pub?output=csv",
        whatsAppPhone: "77780990459",
        minOrderAmount: 30000,
        productsCacheKey: "preorderPharmaProducts_v5_cards",
        quantitiesCacheKey: "preorderPharmaQuantities_v5_cards",
        cacheDuration: 300000,
        localImagePath: "",
        localImageMapping: { "NSHF": "photo_5222374297576798738_y.png" }
      },
      state: { products: [], quantities: {}, filter: "", countdownInterval: null, preorderActive: true },
      elements: {
        appContainer: document.getElementById("app"),
        loader: document.getElementById("loader"),
        productGrid: document.getElementById("product-grid"),
        totalEl: document.getElementById("total"),
        savingsEl: document.getElementById("savings"),
        tierEl: document.getElementById("tier"),
        toastEl: document.getElementById("toast"),
        filterInput: document.getElementById("filterInput"),
        scrollTopBtn: document.getElementById("scrollTopBtn"),
        buyDirectBtn: document.getElementById("buyDirectBtn"),
        copyOrderBtn: document.getElementById("copyOrderBtn"),
        kaspiBtn: document.getElementById("kaspiBtn"),
        minOrderMessage: document.getElementById("minOrderMessage"),
        countdownContainer: document.getElementById("countdown-container"),
        countdownTimer: document.getElementById("countdown-timer")
      },
      init: function() {
        this.bindEvents();
        this.initTimer();
        this.loadData();
      },
      bindEvents: function() {
        this.elements.filterInput.addEventListener("input", (e) => {
          this.state.filter = e.target.value;
          this.renderProducts();
        });
        this.elements.productGrid.addEventListener("click", this.handleQuantityButtonClick.bind(this));
        this.elements.productGrid.addEventListener("change", this.handleQuantityInput.bind(this));
        window.addEventListener("scroll", () => {
          this.elements.scrollTopBtn.classList.toggle("visible", window.scrollY > 300);
        });
        this.elements.scrollTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      },
      initTimer: async function() {
        if (!this.config.timerCsvPath) return;
        try {
          const response = await fetch(this.config.timerCsvPath, { cache: "no-store" });
          if (!response.ok) throw new Error("Network error: " + response.status);
          const csvText = await response.text();
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              if (results.data.length > 0 && results.data[0].EndDate) {
                this.startCountdown(String(results.data[0].EndDate).trim());
              } else {
                this.elements.countdownContainer.style.display = "none";
              }
            }
          });
        } catch (error) {
          console.error("Failed to load timer data:", error);
          this.elements.countdownContainer.style.display = "none";
        }
      },
      startCountdown: function(endDateString) {
        var endDate;
        try {
          var parts = String(endDateString).split(" ")[0].split(".");
          if (parts.length !== 3) throw new Error("Invalid date format");
          var day = parseInt(parts[0], 10);
          var month = parseInt(parts[1], 10) - 1;
          var year = parseInt(parts[2], 10);
          var timePartsFull = String(endDateString).split(" ")[1] ? String(endDateString).split(" ")[1].split(":") : ["0","0","0"];
          endDate = new Date(year, month, day, parseInt(timePartsFull[0] || "0", 10), parseInt(timePartsFull[1] || "0", 10), parseInt(timePartsFull[2] || "0", 10));
          if (isNaN(endDate.getTime())) throw new Error("Invalid date value");
        } catch (err) {
          this.elements.countdownContainer.style.display = "none";
          return;
        }
        this.elements.countdownContainer.style.display = "block";
        var update = () => {
          var now = new Date().getTime();
          var distance = endDate - now;
          if (distance < 0) {
            clearInterval(this.state.countdownInterval);
            this.elements.countdownTimer.textContent = "ПРЕДЗАКАЗ ЗАВЕРШЕН";
            this.elements.countdownContainer.classList.add("expired");
            this.disablePreorder();
            return;
          }
          var days = Math.floor(distance / 86400000);
          var hours = Math.floor((distance % 86400000) / 3600000);
          var minutes = Math.floor((distance % 3600000) / 60000);
          var seconds = Math.floor((distance % 60000) / 1000);
          var pad = function(num){ return String(num).padStart(2, "0"); };
          this.elements.countdownTimer.innerHTML = pad(days) + ":" + pad(hours) + ":" + pad(minutes) + ":" + pad(seconds);
        };
        update();
        this.state.countdownInterval = setInterval(update, 1000);
      },
      disablePreorder: function() {
        this.state.preorderActive = false;
        this.elements.buyDirectBtn.disabled = true;
        this.elements.copyOrderBtn.disabled = true;
        this.elements.kaspiBtn.disabled = true;
        var orderInstructions = document.querySelector(".order-instructions");
        if (orderInstructions) {
          orderInstructions.innerHTML = '<p style="color: var(--tag-bestseller-bg); font-weight: 700;">Прием заказов завершен.</p>';
        }
        this.showToast("Время предзаказа истекло", "warning");
      },
      loadData: async function() {
        var cachedItem = null;
        try { cachedItem = JSON.parse(localStorage.getItem(this.config.productsCacheKey)); } catch(e){}
        if (cachedItem && (Date.now() - cachedItem.timestamp < this.config.cacheDuration)) {
          this.processData(cachedItem.products);
          return;
        }
        try {
          const response = await fetch(this.config.csvPath, { cache: "no-store" });
          if (!response.ok) throw new Error("Network error: " + response.status);
          const csvText = await response.text();
          if (!csvText.trim()) throw new Error("Received empty CSV file");
          this.parseCSV(csvText);
        } catch (error) {
          console.error("Failed to load fresh data:", error);
          if (cachedItem && cachedItem.products) {
            this.showToast("Не удалось обновить прайс. Показана сохраненная версия.", "warning");
            this.processData(cachedItem.products);
          } else {
            this.showError();
          }
        }
      },
      parseCSV: function(csvText) {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            var products = this.parseProducts(results.data);
            if (!products || products.length === 0) {
              this.showError("Прайс-лист пуст или не удалось обработать данные.");
              return;
            }
            try {
              localStorage.setItem(this.config.productsCacheKey, JSON.stringify({ timestamp: Date.now(), products: products }));
            } catch(e){}
            this.processData(products);
          },
          error: () => { this.showError(); }
        });
      },
      parseProducts: function(data) {
        return data
          .filter(function(row){ return row.Название && row["Цена1"] && row.ID; })
          .map((row) => {
            var id = String(row.ID).trim();
            var imageName = this.config.localImageMapping[id] || (id + ".png");
            var imagePath = this.config.localImagePath + imageName;
            return {
              id: id,
              name: String(row.Название || "").trim(),
              prices: {
                p1: parseFloat(row["Цена1"]) || 0,
                p2: parseFloat(row["Цена2"]) || 0,
                p3: parseFloat(row["Цена3"]) || 0
              },
              image: imagePath,
              isBestseller: String(row.бестселлер || "").trim().toLowerCase() === "yes",
              isNew: String(row.новинка || "").trim().toLowerCase() === "yes",
              isLowStock: String(row.мало || "").trim().toLowerCase() === "yes",
              isAvailable: String(row.наличие || "yes").trim().toLowerCase() !== "no"
            };
          })
          .filter(function(product){ return product.isAvailable; });
      },
      processData: function(products) {
        this.state.products = products;
        this.restoreState();
        this.renderProducts();
        this.calculate();
        this.elements.loader.style.display = "none";
        this.elements.appContainer.style.display = "block";
      },
      renderProducts: function() {
        this.elements.productGrid.innerHTML = "";
        var fragment = document.createDocumentFragment();
        var filter = String(this.state.filter || "").toLowerCase();
        this.state.products.forEach((item) => {
          if (filter && item.name.toLowerCase().indexOf(filter) === -1) return;
          var card = document.createElement("div");
          card.className = "product-card";
          card.dataset.id = item.id;

          var tags = [];
          if (item.isBestseller) tags.push('<span class="tag tag-bestseller">🔥 ХИТ</span>');
          if (item.isNew) tags.push('<span class="tag tag-new">✨ НОВИНКА</span>');
          if (item.isLowStock) tags.push('<span class="tag tag-low-stock">⏳ МАЛО</span>');
          var tagsHtml = '<div class="tags-container">' + tags.join("") + "</div>";

          var placeholderImg = "https://placehold.co/300x300/1a1f29/f0f3f7?text=" + encodeURIComponent(item.name.substring(0,3));
          var quantity = this.state.quantities[item.id] || 0;

          card.innerHTML =
            '<div class="product-card-image-wrapper">' +
              '<img src="'+ item.image +'" class="product-card-image" alt="'+ item.name +'" loading="lazy" onerror="this.onerror=null; this.src=\''+ placeholderImg +'\';">' +
              tagsHtml +
            '</div>' +
            '<div class="product-card-content">' +
              '<h3 class="product-card-name">'+ item.name +'</h3>' +
              '<div class="product-card-prices">' +
                 '<div class="price-tier price-tier-1"><span class="price-tier-label">от 1 шт.</span><span class="price-tier-value">'+ item.prices.p1.toLocaleString("ru-RU") +' ₸</span></div>' +
                 '<div class="price-tier price-tier-2"><span class="price-tier-label">от 3 шт.</span><span class="price-tier-value">'+ item.prices.p2.toLocaleString("ru-RU") +' ₸</span></div>' +
                 '<div class="price-tier price-tier-3"><span class="price-tier-label">от 5 шт.</span><span class="price-tier-value">'+ item.prices.p3.toLocaleString("ru-RU") +' ₸</span></div>' +
              '</div>' +
              '<div class="product-card-footer">' +
                '<div class="quantity-control">' +
                  '<button class="quantity-btn" aria-label="Уменьшить количество" data-action="decrease" data-id="'+ item.id +'">-</button>' +
                  '<input type="number" class="quantity-input" min="0" max="99" value="'+ quantity +'" aria-label="Количество" data-id="'+ item.id +'" />' +
                  '<button class="quantity-btn" aria-label="Увеличить количество" data-action="increase" data-id="'+ item.id +'">+</button>' +
                '</div>' +
                '<div class="subtotal"><span class="subtotal-label">Сумма:</span> <span class="subtotal-value">0 ₸</span></div>' +
              '</div>' +
            '</div>';
          fragment.appendChild(card);
        });
        this.elements.productGrid.appendChild(fragment);
        if (!this.elements.productGrid.children.length) {
          this.elements.productGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; padding: 20px;">По вашему запросу ничего не найдено.</p>';
        }
        this.calculate();
      },
      handleQuantityButtonClick: function(event) {
        var button = event.target.closest(".quantity-btn");
        if (!button) return;
        var action = button.dataset.action;
        var id = button.dataset.id;
        var input = this.elements.productGrid.querySelector(".product-card[data-id='"+ id +"'] .quantity-input");
        if (!input) return;
        var value = parseInt(input.value, 10) || 0;
        if (action === "increase" && value < 99) value++;
        else if (action === "decrease" && value > 0) value--;
        input.value = value;
        this.updateAndSave();
      },
      handleQuantityInput: function(event) {
        var input = event.target;
        if (!input.classList.contains("quantity-input")) return;
        var value = parseInt(input.value, 10) || 0;
        input.value = Math.max(0, Math.min(99, isNaN(value) ? 0 : Math.floor(value)));
        this.updateAndSave();
      },
      updateAndSave: function() {
        this.saveState();
        this.calculate();
      },
      calculate: function() {
        var finalTotal = 0;
        if (this.elements.tierEl && this.elements.tierEl.parentElement) this.elements.tierEl.parentElement.style.display = "none";
        if (this.elements.savingsEl && this.elements.savingsEl.parentElement) this.elements.savingsEl.parentElement.style.display = "none";
        this.state.products.forEach((product) => {
          var card = this.elements.productGrid.querySelector(".product-card[data-id='"+ product.id +"']");
          var qty = this.state.quantities[product.id] || 0;
          var price = product.prices.p1;
          var activeTier = 1;
          if (qty >= 5) { price = product.prices.p3; activeTier = 3; }
          else if (qty >= 3) { price = product.prices.p2; activeTier = 2; }
          var subtotal = price * qty;
          finalTotal += subtotal;
          if (card) {
            var subtotalEl = card.querySelector(".subtotal-value");
            if (subtotalEl) subtotalEl.textContent = subtotal.toLocaleString("ru-RU") + " ₸";
            card.querySelectorAll(".price-tier").forEach(function(el){ el.classList.remove("active"); });
            if (qty > 0) {
              var activePriceTierEl = card.querySelector(".price-tier-" + activeTier);
              if (activePriceTierEl) activePriceTierEl.classList.add("active");
            }
          }
        });
        if (this.elements.totalEl) this.elements.totalEl.textContent = finalTotal.toLocaleString("ru-RU") + " ₸";
        var buttonsDisabled = (finalTotal < this.config.minOrderAmount) || !this.state.preorderActive || (finalTotal === 0);
        this.elements.buyDirectBtn.disabled = buttonsDisabled;
        this.elements.copyOrderBtn.disabled = buttonsDisabled;
        this.elements.kaspiBtn.disabled = buttonsDisabled;
        if (this.state.preorderActive && finalTotal > 0 && finalTotal < this.config.minOrderAmount) {
          this.elements.minOrderMessage.textContent = "Минимальная сумма для предзаказа: " + this.config.minOrderAmount.toLocaleString("ru-RU") + " ₸";
          this.elements.minOrderMessage.style.display = "block";
        } else {
          this.elements.minOrderMessage.style.display = "none";
        }
      },
      saveState: function() {
        var quantities = {};
        this.elements.productGrid.querySelectorAll(".quantity-input").forEach(function(input){
          var value = parseInt(input.value, 10);
          if (value > 0) { quantities[input.dataset.id] = value; }
        });
        this.state.quantities = quantities;
        try { localStorage.setItem(this.config.quantitiesCacheKey, JSON.stringify(quantities)); } catch(e){}
      },
      restoreState: function() {
        try { this.state.quantities = JSON.parse(localStorage.getItem(this.config.quantitiesCacheKey) || "{}"); } catch(e){ this.state.quantities = {}; }
      },
      generateOrderData: function(orderType) {
        var orderItems = [];
        for (var id in this.state.quantities) {
          var qty = this.state.quantities[id];
          if (qty <= 0) continue;
          var product = this.state.products.find(function(p){ return p.id === id; });
          if (product) orderItems.push({ product: product, qty: qty });
        }
        if (!orderItems.length) return { orderText: "", hasItems: false };
        
        var finalTotal = 0;
        var headerText = orderType === 'kaspi'
          ? "Здравствуйте! Хочу сделать предзаказ в рассрочку Kaspi 0-0-12:\n"
          : "Здравствуйте! Хочу сделать предзаказ:\n";

        var lines = [headerText];
        
        orderItems.forEach(function(entry){
          var product = entry.product; var qty = entry.qty;
          var price = product.prices.p1;
          if (qty >= 5) price = product.prices.p3;
          else if (qty >= 3) price = product.prices.p2;
          var subtotal = price * qty;
          finalTotal += subtotal;
          lines.push("• " + product.name + " — " + qty + " шт × " + price.toLocaleString("ru-RU") + " ₸ = " + subtotal.toLocaleString("ru-RU") + " ₸");
        });

        lines.push("\nИтоговая сумма: " + finalTotal.toLocaleString("ru-RU") + " ₸");
        lines.push("\nПожалуйста, подтвердите наличие и детали заказа.");
        
        return { orderText: lines.join("\n"), hasItems: true };
      },
      sendOrder: function() {
        var obj = this.generateOrderData('whatsapp');
        if (!obj.hasItems) { this.showToast("Сначала добавьте товары в корзину"); return; }
        var url = "https://wa.me/" + this.config.whatsAppPhone + "?text=" + encodeURIComponent(obj.orderText);
        window.open(url, "_blank");
      },
      sendKaspiOrder: function() {
        var obj = this.generateOrderData('kaspi');
        if (!obj.hasItems) { this.showToast("Сначала добавьте товары в корзину"); return; }
        var url = "https://wa.me/" + this.config.whatsAppPhone + "?text=" + encodeURIComponent(obj.orderText);
        window.open(url, "_blank");
      },
      copyOrderForChat: function() {
        var obj = this.generateOrderData('whatsapp');
        if (!obj.hasItems) { this.showToast("Сначала добавьте товары в корзину"); return; }
        navigator.clipboard.writeText(obj.orderText).then(() => {
          this.showToast("Заказ скопирован! Вставьте его в чат WhatsApp.", "success");
        }).catch(() => { this.showToast("Не удалось скопировать текст"); });
      },
      clearOrder: function() {
        if (Object.keys(this.state.quantities).length === 0) { this.showToast("Корзина уже пуста"); return; }
        if (window.confirm("Вы уверены, что хотите очистить весь заказ?")) {
          this.state.quantities = {};
          try { localStorage.removeItem(this.config.quantitiesCacheKey); } catch(e){}
          this.elements.productGrid.querySelectorAll(".quantity-input").forEach(function(input){ input.value = 0; });
          this.updateAndSave();
          this.showToast("Заказ очищен", "success");
        }
      },
      showToast: function(message, type) {
        var icons = { success: "✅", warning: "⚠️", normal: "ℹ️" };
        this.elements.toastEl.className = "toast-notification";
        if (type) this.elements.toastEl.classList.add(type);
        this.elements.toastEl.textContent = (icons[type] || icons.normal) + " " + message;
        this.elements.toastEl.classList.add("show");
        setTimeout(() => { this.elements.toastEl.classList.remove("show"); }, 4000);
      },
      showError: function(message) {
        var html = ''
          + '<div style="color: #ff6b6b; max-width: 400px; text-align: center;">'
          + '<p><strong>Ошибка</strong></p>'
          + '<p>' + (message || 'Не удалось загрузить прайс-лист.') + '</p>'
          + '<p>Проверьте интернет-соединение и попробуйте обновить страницу.</p>'
          + '<button onclick="location.reload()" style="margin-top: 15px; background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: var(--border-radius); cursor: pointer;">Обновить</button>'
          + '</div>';
        this.elements.loader.innerHTML = html;
      }
    };
    app.init();
  </script>
</body>
</html>